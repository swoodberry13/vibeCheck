<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User's Top Artists</title>
</head>
<body>
    <h1>Artists Array</h1>
     <div id='allArtists'></div>
     <h2>similar artists</h2>
     <div id='similar'></div>
    <h1>User's Top Artists</h1>
    <h3>Long term</h3>
    <div id='long'>
    </div>
    <h3>Medium term</h3>
    <div id='med'>
    </div>
    <h3>Short term</h3>
    <div id='short'>
    </div>
    <script>
      
        // Function to get authorization code from url
        function getCodeFromUrl() {
            var urlParams = new URLSearchParams(window.location.search);
            // console.log(window.location.hash);
            var hash =window.location.hash;
            hash=hash.substring(14, hash.indexOf('&'));
            // console.log(hash);
            

            return hash;
        }
        authCode=getCodeFromUrl();
        authCode= 'Bearer '+authCode;
        let allMyArtists=[];
        let allMyArtistsID=[];


        //term is either short_term, medium_term, or long_term
        //limit goes from 0-50
        //myElem is the html element that has the list
        function listTopArtists(term, limit, myElem){
          url='https://api.spotify.com/v1/me/top/artists?time_range='+term+'&limit='+limit;
          myRequest= fetch(url,{
            method: 'GET',
            headers: {
              'Authorization' : authCode
              }
              }).then(response => response.json())
              .then(data => {
                myString='<ol>';
                topArtistsData=data.items;
                len=topArtistsData.length;
                 for(let i = 0;i<len;i++){
                   myString=myString+'<li>'+topArtistsData[i].name+'</li>';
                   }
                myString=myString+'</ol>';
                document.getElementById(myElem).innerHTML=myString;

                   });
          }

        //takes in an array of artists and adds them to allMyArtists if they're not already there
        //arr1 is name arr2 is id
        function addToAllMyArtists(arr1, arr2){
          len=arr2.length;
          for(let i = 0;i<len;i++){
            if(allMyArtistsID.indexOf(arr2[i])==-1){//checks if ID is there or not
              allMyArtists.push(arr1[i]);
              allMyArtistsID.push(arr2[i]);
              getSimilar(arr2[i]);//adds similar artists to current artist to similarArtists array
            }
          }
          document.getElementById('allArtists').innerHTML=allMyArtists;
        }
        function addToMyArtists(arr1, arr2){
          len=arr2.length;
          const date = new Date();
          let month =parseInt( date.getMonth() + 1);
          let year = parseInt(date.getFullYear());
          year=year-12;
          for(let i = 0;i<len;i++){
            if((allMyArtists.indexOf(arr1[i])==-1) && (allMyArtistsID.indexOf(arr2[i])==-1)){
              url='https://api.spotify.com/v1/artists/'+arr2[i]+'/albums';
              myRequest= fetch(url,{
            method: 'GET',
            headers: {
              'Authorization' : authCode
              }
              }).then(response => response.json())
              .then(data => {
                myDate=data.items[0].release_date;
                myDate= myDate.slice(0,4);
                myYear= parseInt(myDate);

                //if they've released music in the last 12 years add them to allMyArtists
                if(myYear>=year){
                   allMyArtists.push(arr1[i]);
                   allMyArtistsID.push(arr2[i]);
                }
                getSimilar(arr2[i]);
                 
              });
            }
          }
           document.getElementById('allArtists').innerHTML=allMyArtists;
        }

        similarArtists=[];
        similarArtistsID=[];
        // function addToSimilarArtists(arr1, arr2){
        //   len=arr2.length;
        //   for(let i = 0;i<len;i++){
        //     //checks if ID is already in either the similar or the all artists list
        //     if((similarArtistsID.indexOf(arr2[i])==-1)&&(allMyArtistsID.indexOf(arr2[i])==-1)){
        //       similarArtists.push(arr1[i]);
        //       similarArtistsID.push(arr2[i]);
        //     }
        //   }
        //   document.getElementById('similar').innerHTML=similarArtists;
        // }
        function removeDuplicates(arr) {
        return arr.filter((item,
        index) => arr.indexOf(item) === index);
}
        function addToSimilarArtists(arr1, arr2){
          len=arr2.length;
          const date = new Date();
          let month =parseInt( date.getMonth() + 1);
          let year = parseInt(date.getFullYear());
          year=year-12;

          for(let i = 0;i<len;i++){
            //checks if ID is already in either the similar or the all artists list
            if((similarArtistsID.indexOf(arr1[i])==-1)&&(allMyArtistsID.indexOf(arr1[i])==-1)){
               url='https://api.spotify.com/v1/artists/'+arr2[i]+'/albums';
              myRequest= fetch(url,{
            method: 'GET',
            headers: {
              'Authorization' : authCode
              }
              }).then(response => response.json())
              .then(data => {
                myDate=data.items[0].release_date;
                myDate= myDate.slice(0,4);
                myYear= parseInt(myDate);

                //if they've released music in the last 12 years add them to similarArtists
                if(myYear>=year){
                  similarArtists.push(arr1[i]);
                  similarArtistsID.push(arr2[i]);
                }
                // else{
                //   console.log("------ too old for similar --------");
                //   console.log(arr1[i]);
                //   console.log("-----------------------------------");
                //  }
              });
            }
            console.log('------ Duplicate ------');
            console.log(arr1[i]);
            console.log('------------------------');
            }
          
          document.getElementById('similar').innerHTML=similarArtists;
        }

        //adds similar artists to list
        //originalID is the spotify ID of the original artist
        function getSimilar(originalID){
          url='https://api.spotify.com/v1/artists/'+originalID+'/related-artists';
          myRequest= fetch(url,{
            method: 'GET',
            headers: {
              'Authorization' : authCode
              }
              }).then(response => response.json())
              .then(data => {
                simArtists=[];
                simArtistsIDs=[];
                myData=data.artists;
                len= myData.length;
                max=5;// max of how many similar artists to the current artists will be added
                for(let i = 0;i<len;i++){
                  if(i<=max){
                  simArtists.push(myData[i].name);
                  simArtistsIDs.push(myData[i].id);
                  }
                }
                addToSimilarArtists(simArtists, simArtistsIDs);    
              });
        }

        //term is either short_term, medium_term, or long_term
        //limit goes from 0-50
        function getTopArtists(term){
          //artists=[];
          url='https://api.spotify.com/v1/me/top/artists?time_range='+term+'&limit=50';
          myRequest= fetch(url,{
            method: 'GET',
            headers: {
              'Authorization' : authCode
              }
              }).then(response => response.json())
              .then(data => {
                topArtists=[];
                topArtistIDs=[];
                topArtistsData=data.items;
                len=topArtistsData.length;
                 for(let i = 0;i<len;i++){
                   topArtists.push(topArtistsData[i].name);
                   topArtistIDs.push(topArtistsData[i].id);
                 }
                 addToMyArtists(topArtists,topArtistIDs);
                   });     
          }

          //gets top track artists and adds them to allMyArtists if they're not already there
          //term is either short_term, medium_term, or long_term
           //limit goes from 0-50
           function getTopTrackArtists(term){
            artists=[];
            url='https://api.spotify.com/v1/me/top/tracks?time_range='+term+'&limit=50';
            try{
          response=fetch(url,{
            method: 'GET',
            headers: {
              'Authorization' : authCode
              }}).then(response => response.json())
              .then(data => {
                topTrackArtistArr=[];
                topTrackArtistID=[];
                mySongsData=data.items;
                len1= mySongsData.length;

                 for(let i = 0;i<len1;i++){
                   songArtists=mySongsData[i].artists;
                  len2= songArtists.length;

                   for(let q=0;q<len2;q++){
                      topTrackArtistArr.push(songArtists[q].name);
                      topTrackArtistID.push(songArtists[q].id);
                   }
                 }
                 addToMyArtists(topTrackArtistArr,topTrackArtistID);
              });
             }catch (e) { console.log (e) }
          }
          // function logArtists(allArtist, allArtistIDs){
          //   var obj = {
          //     top: [],
          //     suggest:[]
          //     };
          //   len= allArtist.length;
          //   for(let q=0;q<len;q++){
          //     obj.table.push({name: allArtist[q], id:allArtistIDs[q]});
          //   }
          //   const data = JSON.stringify(obj);
          //   fs.writeFile("data.json", data, (error) => {  
          //     if (error) {// logging the error
          //     console.error(error);
          //     throw error;
          //     }
          //     console.log("data.json written correctly");
          //     });
          // }

          //adding artists from top artists
          getTopArtists('long_term');
          getTopArtists('medium_term');
          getTopArtists('short_term');
          //adding artists from top tracks
           getTopTrackArtists('long_term');
           getTopTrackArtists('medium_term');
           getTopTrackArtists('short_term');


           console.log("HERE ARE ALL MY ARTISTS")
           console.log(similarArtistsID)

           //call to test looking at artists
          // urlTEST='https://api.spotify.com/v1/artists/6olE6TJLqED3rqDCT0FyPh/albums';
          // myRequest= fetch(urlTEST,{
          //   method: 'GET',
          //   headers: {
          //     'Authorization' : authCode
          //     }
          //     }).then(response => response.json())
          //     .then(data => {
          //       myDate=data.items[0].release_date;
          //       myDate= myDate.slice(0,5);
          //       myYear= parseInt(myDate);
          //       console.log(data.items[0])
          //       console.log(myYear);
          //       // if(myYear>=year){
          //       //    allMyArtists.push(arr1[i]);
          //       //    allMyArtistsID.push(arr2[i]);
          //       // }
          //       // getSimilar(arr2[i]);
                
          //     });


          //lists top Artists on the page
          listTopArtists('long_term',50,'long');
          listTopArtists('medium_term',50,'med');
          listTopArtists('short_term',50,'short');

    </script>
</body>
</html>
