<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User's Top Artists</title>
</head>
<body>
    <h1>Artists Array</h1>
     <div id='allArtists'></div>
     <h2>similar artists</h2>
     <div id='similar'></div>
     <form name="form" method="post" action="redirect.php">
       <input type='hidden' name='formArtists'>
       <input type='hidden' name='formArtistsID'>
       <input type='hidden' name='formRelatedArtists'>
       <input type='hidden' name='formRelatedArtistsID'>
     </form>
    <script>
      
        // Function to get authorization code from url
        function getCodeFromUrl() {
            var urlParams = new URLSearchParams(window.location.search);
            var hash =window.location.hash;
            hash=hash.substring(14, hash.indexOf('&'));
            return hash;
        }
  
        authCode=getCodeFromUrl();
        authCode= 'Bearer '+authCode; //formatting so it can be used for later calls
        var myArtists=[];
        var myArtistsIDs=[];

        //gets all of the user's top artists (short-term, medium term, and long-term) and adds them to myArtists and myArtistsIDs
        async function getTopArtists(){
          terms=['long_term','medium_term','short_term'];
          //gets all of the top artists for all of the terms offered
          for(let i = 0; i < terms.length; i++){
            artist_url='https://api.spotify.com/v1/me/top/artists?time_range='+terms[i]+'&limit=50';
            const response= await fetch(artist_url,{
            method: 'GET',
            headers: {
              'Authorization' : authCode
              }});  
              const data = await response.json();
              myData=data.items;
              //looping through each artist
              for(let q=0; q<myData.length; q++){
                curName=myData[q].name;
                curID= myData[q].id;
                //if the artist isn't already in the list add them to list
                if(!myArtistsIDs.includes(curID)){
                  getRelatedArtists(curID, 3);//gets artists related to current artist
                  myArtists.push(curName);
                  myArtistsIDs.push(curID);
                }
              }
          }
          return myArtists;
        }


        //gets all the artists from the users top tracks and adds them to the myArtists array
        async function getTopTrackArtists(){
          terms=['long_term','medium_term','short_term'];

          //gets all of the artists for the top tracks for all of the terms offered
          for(let i = 0; i < terms.length; i++){
            url='https://api.spotify.com/v1/me/top/tracks?time_range='+terms[i]+'&limit=50';
            const response= await fetch(url,{
            method: 'GET',
            headers: {
              'Authorization' : authCode
              }}); 
              const data = await response.json();
              myData=data.items;
              //looping through all the songs
              for(let h=0; h< myData.length; h++){
                song_artists=myData[h].artists;
                //looping through each songs artists
                for(let q=0; q < song_artists.length; q++){
                  curID=song_artists[q].id;
                  curName=song_artists[q].name;
                  if(!myArtistsIDs.includes(curID)){
                    getRelatedArtists(curID, 2);//gets artists related to current artist
                    myArtists.push(curName);
                    myArtistsIDs.push(curID);      

                  }
                }
              }
          }
          document.getElementById('allArtists').innerHTML=myArtists;
          return myArtists;
        }

        var relatedArtists=[];
        var relatedArtistsIDs=[];

        //get artists related to myArtists
        //numRelated= how many related artists per artists in myArtists should be added to relatedArtists
        async function getRelatedArtists(id, numRelated){
             url='https://api.spotify.com/v1/artists/'+id+'/related-artists';
             const response= await fetch(url,{
               method: 'GET',
               headers: {
              'Authorization' : authCode
              }}); 
              const data = await response.json();
              cur_related_artists=data.artists;//list of related artists
              //loop through list of related artists
              curNumRelated=0;
               for(let h=0; h<cur_related_artists.length;h++){

                  //if we haven't hit the max_number of related artists
                 if(curNumRelated<=numRelated){
                 
                 //if the artist isn't already in the related list 
                 if((!myArtistsIDs.includes(curID))||(!relatedArtistsIDs.includes(curID))){
                   curNumRelated++;
                   relatedArtists.push(cur_related_artists[h].name);
                   relatedArtistsIDs.push(cur_related_artists[h].id);
                  }
                 }

                }
                return relatedArtists;
          }


          function getArtistArray(){
            arr=[myArtists,myArtistsIDs,relatedArtists,relatedArtistsIDs];
            return arr;
          }

        //gets topTracksArtists and TopArtists and displays them on the page
        //uses await to make sure that 
        async function getMyArtists() {
          myForm= document.forms['form'];
          await getTopArtists();//wait to get top artists
          await getTopTrackArtists();
          let myPromise = new Promise(function(resolve) {
            t=getArtistArray();//returns array with myArtists,myArtistsIDs,relatedArtists,relatedArtistsIDs
            resolve(t);
            console.log("got my Artists");
            console.log(t)
           
            });
            myPromise.then((value) => {
              //displays stuff on page
              document.getElementById("allArtists").innerHTML=value[0];
              myForm.elements["formArtists"].value=value[0];
              myForm.elements["formArtistsID"].value=value[1];

              document.getElementById("similar").innerHTML=value[2];
              myForm.elements["formRelatedArtists"].value=value[2];
              myForm.elements["formRelatedArtistsID"].value=value[2];
              });
          }

          async function sendMyData(){
            await getMyArtists();
            const jsonObject = JSON.stringify(myArtists);
            sessionStorage.setItem('array', jsonObject);
            console.log(myArtists.length);
            document.forms['form'].submit();
          }

          sendMyData();
     
    </script>
</body>
</html>
